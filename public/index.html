<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="./get_position.css">
<script>
function test() {
    navigator.geolocation.getCurrentPosition(test2);
}

function test2(position) {
    s = "観光地にいますか？";
    var geo_text = "緯度:" + position.coords.latitude + "\n";
    geo_text += "経度:" + position.coords.longitude + "\n";

    //la = Math.floor(position.coords.latitude)
    la = Math.floor( position.coords.latitude * Math.pow( 10, 2 ) ) / Math.pow( 10, 2 ) ;
    //lo = Math.floor(position.coords.longitude)
    lo= Math.floor( position.coords.longitude * Math.pow( 10, 2 ) ) / Math.pow( 10, 2 ) ;

    
    if (la == 35.32 && lo == 139.56) {
        //正解
        l = "/KAMAKURAGU_Quiz.html";
        setTimeout(function(){window.open('/KAMAKURAGU_Quiz.html');}, 5*1000);
        s = "鎌倉宮のクイズ";
    }else if(la == 35.59 && lo == 139.60){
        l = "/HACHIMANGU_Quiz.html";
        setTimeout(function(){window.open('/HACHIMANGU_Quiz.html');}, 5*1000);
        s = "八幡宮のクイズ";
    } else {
        l = "";
        s = "クイズがありません";
    }
    document.getElementById("text_q").innerHTML = s;

}
</script>
</head>
<body>
    
    <button class="btn block" onclick="test()">位置情報取得</button>
    <div class="locat result" id="text_q">クイズを探す</div>
    
    <div class="p_locat_name">
      <div class="locat_name" id="user_name"></div>
    </div>
    <div class="p_prob">
      <div class="prob_ans" id="probN"></div>
      <div class="prob_ans" id="probM"></div>
    </div>
    <div class="button-area">
        <!-- spanタグにボタンの機能を持たせる -->
        <span id="button_class">あなたの称号は？</span>
    </div>

<!-- liffのjs -->
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<!-- firebase databaseのスクリプト -->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.3/firebase-app.js";
  import {getDatabase, ref, set, child, update, remove, get}
  from "https://www.gstatic.com/firebasejs/9.8.3/firebase-database.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries
  // Initialize Firebase
    liff.init({
    liffId: '1657230531-EW5Dv37V', // Use own liffId
    withLoginOnExternalBrowser: true, // Enable automatic login process
  }).then(() => {
    const idToken = liff.getDecodedIDToken();
    const name = idToken['name'];
    const ID = idToken['sub'];
    document.getElementById("user_name").innerHTML = "&emsp;&emsp;ようこそ!<br>"+name+" さん!";

    const firebaseConfig = {
    apiKey: "AIzaSyDrmYDLon18d7MqCU5yYAUXI5A_yTPl3js",
    authDomain: "locationquiz-6ea9f.firebaseapp.com",
    projectId: "locationquiz-6ea9f",
    storageBucket: "locationquiz-6ea9f.appspot.com",
    messagingSenderId: "630966647062",
    appId: "1:630966647062:web:f3ab6cf45bf8236530f837"
  };

  const app = initializeApp(firebaseConfig);

  const db = getDatabase();

  const dbRef = ref(getDatabase());
  get(child(dbRef, `users/${ID}`)).then((snapshot) => {
  if (snapshot.exists()) {
    document.getElementById("probN").innerHTML = '前回の鎌倉宮クイズの成績：'+snapshot.val()['probN'] + '問正解';
    document.getElementById("probM").innerHTML = '前回の八幡宮クイズの成績：'+snapshot.val()['probM'] + '問正解';
  } else {
    set(ref(db, 'users/' + ID), {
    username: name,
    probM:0,
    probN:0,
    class:'商人'
  });
  }
  }).catch((error) => {
  console.error(error);
  });

  function sendClass() {
    const db = getDatabase();
    const dbRef = ref(getDatabase());
    get(child(dbRef, `users/${ID}`)).then((snapshot) => {
    var class_name = snapshot.val()['class'];
    liff
    .sendMessages([
      {
        type: "text",
        text: class_name,
      },
    ])
    .then(function () {
      window.alert('称号を送りました');
    });
  })
  }
  const btn = document.getElementById('button_class')
  btn.addEventListener('click', sendClass)

  });
</script>

</body>
</html>